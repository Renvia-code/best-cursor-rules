---
description: Playwright best practices for end-to-end testing with fixtures and page objects
globs: ["**/*.spec.ts", "e2e/**/*", "tests/**/*.spec.ts"]
alwaysApply: false
---

# Playwright Best Practices

## Overview

| Aspect | Recommendation |
|--------|----------------|
| Pattern | Page Object Model |
| Assertions | Web-first assertions |
| Selectors | Test IDs or role-based |
| Parallel | Run tests in parallel |

---

## Configuration

### playwright.config.ts

```typescript
import { defineConfig, devices } from '@playwright/test'

export default defineConfig({
  testDir: './e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  use: {
    baseURL: 'http://localhost:3000',
    trace: 'on-first-retry',
    screenshot: 'only-on-failure',
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
    {
      name: 'firefox',
      use: { ...devices['Desktop Firefox'] },
    },
    {
      name: 'webkit',
      use: { ...devices['Desktop Safari'] },
    },
    {
      name: 'Mobile Chrome',
      use: { ...devices['Pixel 5'] },
    },
  ],
  webServer: {
    command: 'npm run dev',
    url: 'http://localhost:3000',
    reuseExistingServer: !process.env.CI,
  },
})
```

---

## Basic Tests

### First Test

```typescript
import { test, expect } from '@playwright/test'

test('homepage has title', async ({ page }) => {
  await page.goto('/')
  
  await expect(page).toHaveTitle(/My App/)
})

test('navigation works', async ({ page }) => {
  await page.goto('/')
  
  await page.getByRole('link', { name: 'About' }).click()
  
  await expect(page).toHaveURL('/about')
  await expect(page.getByRole('heading', { name: 'About Us' })).toBeVisible()
})
```

---

## Selectors

### Recommended (Role-based)

```typescript
// ✅ Best - Role-based selectors
await page.getByRole('button', { name: 'Submit' }).click()
await page.getByRole('textbox', { name: 'Email' }).fill('test@example.com')
await page.getByRole('link', { name: 'Home' }).click()
await page.getByRole('heading', { level: 1 }).toBeVisible()

// ✅ Good - Test IDs
await page.getByTestId('submit-button').click()

// ✅ Good - Labels and placeholders
await page.getByLabel('Email').fill('test@example.com')
await page.getByPlaceholder('Search...').fill('query')
await page.getByText('Welcome back').toBeVisible()
```

### Avoid

```typescript
// ❌ Avoid - CSS selectors (brittle)
await page.locator('.btn-primary').click()

// ❌ Avoid - XPath
await page.locator('//button[@class="submit"]').click()

// ❌ Avoid - DOM structure dependent
await page.locator('div > div > button').click()
```

---

## Page Object Model

### Page Object

```typescript
// e2e/pages/login.page.ts
import { Page, Locator, expect } from '@playwright/test'

export class LoginPage {
  readonly page: Page
  readonly emailInput: Locator
  readonly passwordInput: Locator
  readonly submitButton: Locator
  readonly errorMessage: Locator

  constructor(page: Page) {
    this.page = page
    this.emailInput = page.getByLabel('Email')
    this.passwordInput = page.getByLabel('Password')
    this.submitButton = page.getByRole('button', { name: 'Sign In' })
    this.errorMessage = page.getByRole('alert')
  }

  async goto() {
    await this.page.goto('/login')
  }

  async login(email: string, password: string) {
    await this.emailInput.fill(email)
    await this.passwordInput.fill(password)
    await this.submitButton.click()
  }

  async expectError(message: string) {
    await expect(this.errorMessage).toContainText(message)
  }
}
```

### Using Page Objects

```typescript
// e2e/auth.spec.ts
import { test, expect } from '@playwright/test'
import { LoginPage } from './pages/login.page'

test.describe('Authentication', () => {
  let loginPage: LoginPage

  test.beforeEach(async ({ page }) => {
    loginPage = new LoginPage(page)
    await loginPage.goto()
  })

  test('successful login redirects to dashboard', async ({ page }) => {
    await loginPage.login('user@example.com', 'password123')
    
    await expect(page).toHaveURL('/dashboard')
  })

  test('invalid credentials shows error', async () => {
    await loginPage.login('wrong@example.com', 'wrongpassword')
    
    await loginPage.expectError('Invalid credentials')
  })
})
```

---

## Fixtures

### Custom Fixtures

```typescript
// e2e/fixtures.ts
import { test as base } from '@playwright/test'
import { LoginPage } from './pages/login.page'
import { DashboardPage } from './pages/dashboard.page'

type Fixtures = {
  loginPage: LoginPage
  dashboardPage: DashboardPage
  authenticatedPage: void
}

export const test = base.extend<Fixtures>({
  loginPage: async ({ page }, use) => {
    const loginPage = new LoginPage(page)
    await use(loginPage)
  },

  dashboardPage: async ({ page }, use) => {
    const dashboardPage = new DashboardPage(page)
    await use(dashboardPage)
  },

  authenticatedPage: async ({ page }, use) => {
    // Setup: Log in before test
    await page.goto('/login')
    await page.getByLabel('Email').fill('test@example.com')
    await page.getByLabel('Password').fill('password123')
    await page.getByRole('button', { name: 'Sign In' }).click()
    await page.waitForURL('/dashboard')
    
    await use()
    
    // Teardown: Log out after test (if needed)
  },
})

export { expect } from '@playwright/test'
```

### Using Fixtures

```typescript
// e2e/dashboard.spec.ts
import { test, expect } from './fixtures'

test.describe('Dashboard', () => {
  test('shows user profile', async ({ authenticatedPage, page }) => {
    // Already logged in via fixture
    await expect(page.getByText('Welcome back')).toBeVisible()
  })
})
```

---

## API Testing

```typescript
import { test, expect } from '@playwright/test'

test('API returns users', async ({ request }) => {
  const response = await request.get('/api/users')
  
  expect(response.ok()).toBeTruthy()
  
  const users = await response.json()
  expect(users).toHaveLength(10)
})

test('create user via API', async ({ request }) => {
  const response = await request.post('/api/users', {
    data: {
      name: 'John',
      email: 'john@example.com',
    },
  })
  
  expect(response.status()).toBe(201)
})
```

---

## Waiting and Assertions

### Auto-waiting

```typescript
// Playwright auto-waits for elements
await page.getByRole('button').click()  // Waits for button to be actionable

// Explicit wait for navigation
await page.waitForURL('/dashboard')

// Wait for network idle
await page.waitForLoadState('networkidle')

// Wait for specific response
await page.waitForResponse('**/api/users')
```

### Web-first Assertions

```typescript
// ✅ Auto-retrying assertions
await expect(page.getByText('Success')).toBeVisible()
await expect(page.getByRole('button')).toBeEnabled()
await expect(page).toHaveURL('/dashboard')
await expect(page).toHaveTitle('Dashboard')

// With timeout
await expect(page.getByText('Loaded')).toBeVisible({ timeout: 10000 })
```

---

## Commands

```bash
# Run all tests
npx playwright test

# Run specific file
npx playwright test e2e/login.spec.ts

# Run with UI
npx playwright test --ui

# Run in headed mode
npx playwright test --headed

# Run specific project
npx playwright test --project=chromium

# Debug mode
npx playwright test --debug

# Generate code
npx playwright codegen localhost:3000

# Show report
npx playwright show-report
```

---

## Common Mistakes

| Mistake | Fix |
|---------|-----|
| Using `waitForTimeout` | Use auto-waiting or `waitFor*` methods |
| CSS selectors | Use role-based or test ID selectors |
| Not using Page Objects | Extract common interactions |
| Flaky tests | Add proper waits and assertions |
| Testing in one browser | Run across multiple browsers |
| No fixtures | Use fixtures for setup/teardown |
