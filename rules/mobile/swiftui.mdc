---
description: SwiftUI best practices for iOS, macOS, and cross-platform Apple development
globs: ["**/*.swift"]
alwaysApply: false
---

# SwiftUI Best Practices

## Overview

| Aspect | Recommendation |
|--------|----------------|
| Version | iOS 17+ / SwiftUI 5 |
| Architecture | MVVM |
| State | @Observable (iOS 17+) |
| Navigation | NavigationStack |
| Concurrency | Swift Concurrency (async/await) |

---

## Project Structure

```
App/
├── App.swift                 # @main entry point
├── ContentView.swift
├── Features/
│   ├── Auth/
│   │   ├── Views/
│   │   │   ├── LoginView.swift
│   │   │   └── RegisterView.swift
│   │   ├── ViewModels/
│   │   │   └── AuthViewModel.swift
│   │   └── Models/
│   │       └── User.swift
│   └── Home/
│       └── ...
├── Core/
│   ├── Network/
│   │   └── APIClient.swift
│   ├── Storage/
│   │   └── UserDefaults+Extensions.swift
│   └── Extensions/
├── Shared/
│   ├── Components/
│   │   ├── PrimaryButton.swift
│   │   └── LoadingView.swift
│   └── Modifiers/
└── Resources/
    └── Assets.xcassets
```

---

## View Patterns

### Basic View

```swift
struct ProfileView: View {
    let user: User
    
    var body: some View {
        VStack(alignment: .leading, spacing: 16) {
            AsyncImage(url: user.avatarURL) { image in
                image
                    .resizable()
                    .aspectRatio(contentMode: .fill)
            } placeholder: {
                ProgressView()
            }
            .frame(width: 100, height: 100)
            .clipShape(Circle())
            
            Text(user.name)
                .font(.title2)
                .fontWeight(.semibold)
            
            Text(user.email)
                .font(.subheadline)
                .foregroundStyle(.secondary)
        }
        .padding()
    }
}

#Preview {
    ProfileView(user: .preview)
}
```

### View with ViewModel

```swift
struct HomeView: View {
    @State private var viewModel = HomeViewModel()
    
    var body: some View {
        NavigationStack {
            Group {
                switch viewModel.state {
                case .loading:
                    ProgressView()
                case .loaded(let items):
                    ItemList(items: items)
                case .error(let message):
                    ErrorView(message: message, retry: viewModel.load)
                }
            }
            .navigationTitle("Home")
            .task {
                await viewModel.load()
            }
        }
    }
}
```

---

## State Management (iOS 17+)

### @Observable ViewModel

```swift
import Observation

@Observable
final class HomeViewModel {
    enum State {
        case loading
        case loaded([Item])
        case error(String)
    }
    
    private(set) var state: State = .loading
    private let repository: ItemRepository
    
    init(repository: ItemRepository = .shared) {
        self.repository = repository
    }
    
    func load() async {
        state = .loading
        do {
            let items = try await repository.fetchItems()
            state = .loaded(items)
        } catch {
            state = .error(error.localizedDescription)
        }
    }
    
    func deleteItem(at offsets: IndexSet) async {
        guard case .loaded(var items) = state else { return }
        
        for index in offsets {
            do {
                try await repository.delete(items[index])
                items.remove(at: index)
            } catch {
                state = .error(error.localizedDescription)
                return
            }
        }
        state = .loaded(items)
    }
}
```

### State in Views

```swift
struct CounterView: View {
    @State private var count = 0
    
    var body: some View {
        VStack(spacing: 20) {
            Text("\(count)")
                .font(.largeTitle)
            
            HStack(spacing: 20) {
                Button("−") { count -= 1 }
                Button("+") { count += 1 }
            }
            .buttonStyle(.bordered)
        }
    }
}
```

### Environment Values

```swift
// Define custom environment key
private struct APIClientKey: EnvironmentKey {
    static let defaultValue = APIClient.shared
}

extension EnvironmentValues {
    var apiClient: APIClient {
        get { self[APIClientKey.self] }
        set { self[APIClientKey.self] = newValue }
    }
}

// Usage in view
struct MyView: View {
    @Environment(\.apiClient) private var apiClient
    
    var body: some View {
        // ...
    }
}
```

---

## Navigation

### NavigationStack

```swift
struct AppView: View {
    @State private var path = NavigationPath()
    
    var body: some View {
        NavigationStack(path: $path) {
            HomeView()
                .navigationDestination(for: Item.self) { item in
                    ItemDetailView(item: item)
                }
                .navigationDestination(for: User.self) { user in
                    ProfileView(user: user)
                }
        }
    }
}

// Navigate programmatically
path.append(item)      // Push
path.removeLast()      // Pop
path = NavigationPath() // Pop to root
```

### Tab Navigation

```swift
struct MainTabView: View {
    @State private var selectedTab = 0
    
    var body: some View {
        TabView(selection: $selectedTab) {
            HomeView()
                .tabItem {
                    Label("Home", systemImage: "house")
                }
                .tag(0)
            
            ProfileView()
                .tabItem {
                    Label("Profile", systemImage: "person")
                }
                .tag(1)
        }
    }
}
```

---

## Networking

```swift
actor APIClient {
    static let shared = APIClient()
    
    private let baseURL = URL(string: "https://api.example.com")!
    private let decoder: JSONDecoder = {
        let decoder = JSONDecoder()
        decoder.keyDecodingStrategy = .convertFromSnakeCase
        decoder.dateDecodingStrategy = .iso8601
        return decoder
    }()
    
    func fetch<T: Decodable>(_ endpoint: String) async throws -> T {
        let url = baseURL.appendingPathComponent(endpoint)
        let (data, response) = try await URLSession.shared.data(from: url)
        
        guard let httpResponse = response as? HTTPURLResponse,
              200..<300 ~= httpResponse.statusCode else {
            throw APIError.invalidResponse
        }
        
        return try decoder.decode(T.self, from: data)
    }
    
    func post<T: Codable, R: Decodable>(_ endpoint: String, body: T) async throws -> R {
        var request = URLRequest(url: baseURL.appendingPathComponent(endpoint))
        request.httpMethod = "POST"
        request.setValue("application/json", forHTTPHeaderField: "Content-Type")
        request.httpBody = try JSONEncoder().encode(body)
        
        let (data, _) = try await URLSession.shared.data(for: request)
        return try decoder.decode(R.self, from: data)
    }
}

enum APIError: Error {
    case invalidResponse
    case decodingError
}
```

---

## Forms

```swift
struct SettingsForm: View {
    @State private var name = ""
    @State private var email = ""
    @State private var notificationsEnabled = true
    @State private var selectedTheme = Theme.system
    
    var body: some View {
        Form {
            Section("Profile") {
                TextField("Name", text: $name)
                TextField("Email", text: $email)
                    .textContentType(.emailAddress)
                    .keyboardType(.emailAddress)
                    .autocapitalization(.none)
            }
            
            Section("Preferences") {
                Toggle("Enable Notifications", isOn: $notificationsEnabled)
                
                Picker("Theme", selection: $selectedTheme) {
                    ForEach(Theme.allCases) { theme in
                        Text(theme.displayName).tag(theme)
                    }
                }
            }
            
            Section {
                Button("Save", action: save)
                    .frame(maxWidth: .infinity)
            }
        }
    }
    
    private func save() {
        // Handle save
    }
}

enum Theme: String, CaseIterable, Identifiable {
    case system, light, dark
    
    var id: String { rawValue }
    var displayName: String { rawValue.capitalized }
}
```

---

## Custom Components

### Reusable Button

```swift
struct PrimaryButton: View {
    let title: String
    let isLoading: Bool
    let action: () -> Void
    
    init(_ title: String, isLoading: Bool = false, action: @escaping () -> Void) {
        self.title = title
        self.isLoading = isLoading
        self.action = action
    }
    
    var body: some View {
        Button(action: action) {
            HStack(spacing: 8) {
                if isLoading {
                    ProgressView()
                        .tint(.white)
                }
                Text(title)
            }
            .frame(maxWidth: .infinity)
            .padding(.vertical, 14)
            .background(.blue)
            .foregroundStyle(.white)
            .fontWeight(.semibold)
            .clipShape(RoundedRectangle(cornerRadius: 12))
        }
        .disabled(isLoading)
    }
}
```

### View Modifier

```swift
struct CardStyle: ViewModifier {
    func body(content: Content) -> some View {
        content
            .padding()
            .background(.background)
            .clipShape(RoundedRectangle(cornerRadius: 12))
            .shadow(color: .black.opacity(0.1), radius: 8, y: 4)
    }
}

extension View {
    func cardStyle() -> some View {
        modifier(CardStyle())
    }
}

// Usage
Text("Content")
    .cardStyle()
```

---

## Async/Await Patterns

```swift
struct PostsView: View {
    @State private var posts: [Post] = []
    @State private var isLoading = false
    @State private var error: Error?
    
    var body: some View {
        List(posts) { post in
            PostRow(post: post)
        }
        .overlay {
            if isLoading {
                ProgressView()
            }
        }
        .task {
            await loadPosts()
        }
        .refreshable {
            await loadPosts()
        }
    }
    
    private func loadPosts() async {
        isLoading = true
        defer { isLoading = false }
        
        do {
            posts = try await APIClient.shared.fetch("posts")
        } catch {
            self.error = error
        }
    }
}
```

---

## Commands

```bash
# Build
xcodebuild -scheme MyApp build

# Test
xcodebuild test -scheme MyApp -destination 'platform=iOS Simulator,name=iPhone 15'

# Archive
xcodebuild archive -scheme MyApp -archivePath MyApp.xcarchive
```

---

## Common Mistakes

| Mistake | Fix |
|---------|-----|
| Heavy work in `body` | Move to `task` or ViewModel |
| Not using `@Observable` | Migrate from ObservableObject |
| Force unwrapping optionals | Use `if let` or `guard` |
| Forgetting `#Preview` | Add for faster iteration |
| Inline complex logic | Extract to computed properties |
| Not handling loading/error | Always show appropriate states |
