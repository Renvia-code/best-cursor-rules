---
description: Next.js 15 App Router best practices with Server Components, Server Actions, and modern patterns
globs: ["**/*.tsx", "**/*.ts", "app/**/*", "src/app/**/*"]
alwaysApply: false
---

# Next.js 15 Best Practices

## Overview

| Aspect | Recommendation |
|--------|----------------|
| Router | App Router (default) |
| Components | Server Components by default |
| Data Fetching | async/await in Server Components |
| Forms | Server Actions + useActionState |
| Styling | Tailwind CSS or CSS Modules |

---

## Server Components (Default)

Server Components are the default in App Router. Only use `'use client'` when needed.

### When to use Client Components

```tsx
'use client'  // Add ONLY when you need:

// ✅ Browser APIs (window, localStorage)
// ✅ Event handlers (onClick, onChange)
// ✅ Hooks (useState, useEffect, useContext)
// ✅ Third-party client libraries
```

### ✅ DO: Keep components server-side by default

```tsx
// app/users/page.tsx - Server Component (no directive needed)
export default async function UsersPage() {
  const users = await getUsers()  // Direct database/API call
  return <UserList users={users} />
}
```

### ❌ DON'T: Add 'use client' unnecessarily

```tsx
// Bad - this doesn't need to be a client component
'use client'
export default function About() {
  return <div>About us</div>  // No interactivity needed
}
```

---

## Data Fetching

### Fetch in Server Components

```tsx
// app/products/page.tsx
async function getProducts() {
  const res = await fetch('https://api.example.com/products', {
    next: { revalidate: 3600 }  // Cache for 1 hour
  })
  return res.json()
}

export default async function ProductsPage() {
  const products = await getProducts()
  return <ProductGrid products={products} />
}
```

### Cache Options

| Option | Use Case |
|--------|----------|
| `{ cache: 'force-cache' }` | Static data (default) |
| `{ cache: 'no-store' }` | Dynamic data (every request) |
| `{ next: { revalidate: 60 } }` | ISR - revalidate every 60s |

---

## Server Actions

### Form with Server Action

```tsx
// app/actions.ts
'use server'

export async function createUser(formData: FormData) {
  const name = formData.get('name')
  await db.user.create({ data: { name } })
  revalidatePath('/users')
}
```

```tsx
// app/users/new/page.tsx
import { createUser } from '@/app/actions'

export default function NewUserPage() {
  return (
    <form action={createUser}>
      <input name="name" required />
      <button type="submit">Create</button>
    </form>
  )
}
```

### useActionState for Form State

```tsx
'use client'
import { useActionState } from 'react'
import { createUser } from '@/app/actions'

export default function UserForm() {
  const [state, formAction, isPending] = useActionState(createUser, null)
  
  return (
    <form action={formAction}>
      <input name="name" disabled={isPending} />
      <button disabled={isPending}>
        {isPending ? 'Creating...' : 'Create'}
      </button>
      {state?.error && <p>{state.error}</p>}
    </form>
  )
}
```

---

## Async Request APIs (Next.js 15)

Next.js 15 made these APIs async:

```tsx
// ✅ Correct - await the APIs
import { cookies, headers, draftMode } from 'next/headers'

export default async function Page() {
  const cookieStore = await cookies()
  const headersList = await headers()
  const { isEnabled } = await draftMode()
  
  return <div>...</div>
}
```

### Async Params and SearchParams

```tsx
// app/blog/[slug]/page.tsx
type Props = {
  params: Promise<{ slug: string }>
  searchParams: Promise<{ page?: string }>
}

export default async function BlogPost({ params, searchParams }: Props) {
  const { slug } = await params
  const { page } = await searchParams
  
  return <Article slug={slug} page={page} />
}
```

---

## Project Structure

```
app/
├── (auth)/              # Route group (no URL impact)
│   ├── login/
│   └── register/
├── (dashboard)/
│   ├── layout.tsx       # Shared dashboard layout
│   └── settings/
├── api/
│   └── users/
│       └── route.ts     # API route
├── layout.tsx           # Root layout
├── page.tsx             # Home page
└── globals.css
```

---

## Layouts and Templates

### Root Layout (Required)

```tsx
// app/layout.tsx
export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="en">
      <body>{children}</body>
    </html>
  )
}
```

### Nested Layouts

```tsx
// app/dashboard/layout.tsx
export default function DashboardLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <div className="flex">
      <Sidebar />
      <main>{children}</main>
    </div>
  )
}
```

---

## Loading and Error States

### Loading UI

```tsx
// app/dashboard/loading.tsx
export default function Loading() {
  return <Skeleton />
}
```

### Error Handling

```tsx
// app/dashboard/error.tsx
'use client'

export default function Error({
  error,
  reset,
}: {
  error: Error
  reset: () => void
}) {
  return (
    <div>
      <h2>Something went wrong!</h2>
      <button onClick={reset}>Try again</button>
    </div>
  )
}
```

---

## Metadata

```tsx
// app/page.tsx
import type { Metadata } from 'next'

export const metadata: Metadata = {
  title: 'Home',
  description: 'Welcome to our site',
}

// Dynamic metadata
export async function generateMetadata({ params }): Promise<Metadata> {
  const product = await getProduct(params.id)
  return { title: product.name }
}
```

---

## Common Patterns

### Parallel Data Fetching

```tsx
export default async function Page() {
  // ✅ Fetch in parallel
  const [users, posts] = await Promise.all([
    getUsers(),
    getPosts()
  ])
  
  return <Dashboard users={users} posts={posts} />
}
```

### Streaming with Suspense

```tsx
import { Suspense } from 'react'

export default function Page() {
  return (
    <div>
      <h1>Dashboard</h1>
      <Suspense fallback={<Loading />}>
        <SlowComponent />
      </Suspense>
    </div>
  )
}
```

---

## Common Mistakes

| Mistake | Solution |
|---------|----------|
| Using `'use client'` everywhere | Only add when needed for interactivity |
| Fetching in useEffect | Fetch in Server Components |
| Not awaiting cookies/headers | Always await in Next.js 15 |
| Sequential fetches | Use Promise.all for parallel |
| Giant client bundles | Keep most logic server-side |
